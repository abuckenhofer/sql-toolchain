name: SQLFluff Lint

on:
  push:

permissions:
  contents: read
  checks: write

jobs:
  sqlfluff:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install SQLFluff + custom rules
        run: |
          python -m pip install --upgrade pip
          python -m pip install sqlfluff
          python -m pip install -e ./sqlfluff_rules

      - name: Lint SQL in src (create annotations json)
        run: |
          python -m sqlfluff lint src \
            --format github-annotation \
            --annotation-level failure \
            --write-output sqlfluff_annotations.json

      - name: Publish annotations
        uses: yuzutech/annotations-action@v0.5.0
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"
          title: "SQLFluff"
          input: "sqlfluff_annotations.json"
